const t=window.ShadowRoot&&(void 0===window.ShadyCSS||window.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,e=Symbol();class i{constructor(t,i){if(i!==e)throw Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=t}get styleSheet(){return t&&void 0===this.t&&(this.t=new CSSStyleSheet,this.t.replaceSync(this.cssText)),this.t}toString(){return this.cssText}}const s=new Map,n=t=>{let n=s.get(t);return void 0===n&&s.set(t,n=new i(t,e)),n},r=t?t=>t:t=>t instanceof CSSStyleSheet?(t=>{let e="";for(const i of t.cssRules)e+=i.cssText;return(t=>n("string"==typeof t?t:t+""))(e)})(t):t;var o,a,l,h;const c={toAttribute(t,e){switch(e){case Boolean:t=t?"":null;break;case Object:case Array:t=null==t?t:JSON.stringify(t)}return t},fromAttribute(t,e){let i=t;switch(e){case Boolean:i=null!==t;break;case Number:i=null===t?null:Number(t);break;case Object:case Array:try{i=JSON.parse(t)}catch(t){i=null}}return i}},d=(t,e)=>e!==t&&(e==e||t==t),u={attribute:!0,type:String,converter:c,reflect:!1,hasChanged:d};class p extends HTMLElement{constructor(){super(),this.Πi=new Map,this.Πo=void 0,this.Πl=void 0,this.isUpdatePending=!1,this.hasUpdated=!1,this.Πh=null,this.u()}static addInitializer(t){var e;null!==(e=this.v)&&void 0!==e||(this.v=[]),this.v.push(t)}static get observedAttributes(){this.finalize();const t=[];return this.elementProperties.forEach(((e,i)=>{const s=this.Πp(i,e);void 0!==s&&(this.Πm.set(s,i),t.push(s))})),t}static createProperty(t,e=u){if(e.state&&(e.attribute=!1),this.finalize(),this.elementProperties.set(t,e),!e.noAccessor&&!this.prototype.hasOwnProperty(t)){const i="symbol"==typeof t?Symbol():"__"+t,s=this.getPropertyDescriptor(t,i,e);void 0!==s&&Object.defineProperty(this.prototype,t,s)}}static getPropertyDescriptor(t,e,i){return{get(){return this[e]},set(s){const n=this[t];this[e]=s,this.requestUpdate(t,n,i)},configurable:!0,enumerable:!0}}static getPropertyOptions(t){return this.elementProperties.get(t)||u}static finalize(){if(this.hasOwnProperty("finalized"))return!1;this.finalized=!0;const t=Object.getPrototypeOf(this);if(t.finalize(),this.elementProperties=new Map(t.elementProperties),this.Πm=new Map,this.hasOwnProperty("properties")){const t=this.properties,e=[...Object.getOwnPropertyNames(t),...Object.getOwnPropertySymbols(t)];for(const i of e)this.createProperty(i,t[i])}return this.elementStyles=this.finalizeStyles(this.styles),!0}static finalizeStyles(t){const e=[];if(Array.isArray(t)){const i=new Set(t.flat(1/0).reverse());for(const t of i)e.unshift(r(t))}else void 0!==t&&e.push(r(t));return e}static Πp(t,e){const i=e.attribute;return!1===i?void 0:"string"==typeof i?i:"string"==typeof t?t.toLowerCase():void 0}u(){var t;this.Πg=new Promise((t=>this.enableUpdating=t)),this.L=new Map,this.Π_(),this.requestUpdate(),null===(t=this.constructor.v)||void 0===t||t.forEach((t=>t(this)))}addController(t){var e,i;(null!==(e=this.ΠU)&&void 0!==e?e:this.ΠU=[]).push(t),void 0!==this.renderRoot&&this.isConnected&&(null===(i=t.hostConnected)||void 0===i||i.call(t))}removeController(t){var e;null===(e=this.ΠU)||void 0===e||e.splice(this.ΠU.indexOf(t)>>>0,1)}Π_(){this.constructor.elementProperties.forEach(((t,e)=>{this.hasOwnProperty(e)&&(this.Πi.set(e,this[e]),delete this[e])}))}createRenderRoot(){var e;const i=null!==(e=this.shadowRoot)&&void 0!==e?e:this.attachShadow(this.constructor.shadowRootOptions);return((e,i)=>{t?e.adoptedStyleSheets=i.map((t=>t instanceof CSSStyleSheet?t:t.styleSheet)):i.forEach((t=>{const i=document.createElement("style");i.textContent=t.cssText,e.appendChild(i)}))})(i,this.constructor.elementStyles),i}connectedCallback(){var t;void 0===this.renderRoot&&(this.renderRoot=this.createRenderRoot()),this.enableUpdating(!0),null===(t=this.ΠU)||void 0===t||t.forEach((t=>{var e;return null===(e=t.hostConnected)||void 0===e?void 0:e.call(t)})),this.Πl&&(this.Πl(),this.Πo=this.Πl=void 0)}enableUpdating(t){}disconnectedCallback(){var t;null===(t=this.ΠU)||void 0===t||t.forEach((t=>{var e;return null===(e=t.hostDisconnected)||void 0===e?void 0:e.call(t)})),this.Πo=new Promise((t=>this.Πl=t))}attributeChangedCallback(t,e,i){this.K(t,i)}Πj(t,e,i=u){var s,n;const r=this.constructor.Πp(t,i);if(void 0!==r&&!0===i.reflect){const o=(null!==(n=null===(s=i.converter)||void 0===s?void 0:s.toAttribute)&&void 0!==n?n:c.toAttribute)(e,i.type);this.Πh=t,null==o?this.removeAttribute(r):this.setAttribute(r,o),this.Πh=null}}K(t,e){var i,s,n;const r=this.constructor,o=r.Πm.get(t);if(void 0!==o&&this.Πh!==o){const t=r.getPropertyOptions(o),a=t.converter,l=null!==(n=null!==(s=null===(i=a)||void 0===i?void 0:i.fromAttribute)&&void 0!==s?s:"function"==typeof a?a:null)&&void 0!==n?n:c.fromAttribute;this.Πh=o,this[o]=l(e,t.type),this.Πh=null}}requestUpdate(t,e,i){let s=!0;void 0!==t&&(((i=i||this.constructor.getPropertyOptions(t)).hasChanged||d)(this[t],e)?(this.L.has(t)||this.L.set(t,e),!0===i.reflect&&this.Πh!==t&&(void 0===this.Πk&&(this.Πk=new Map),this.Πk.set(t,i))):s=!1),!this.isUpdatePending&&s&&(this.Πg=this.Πq())}async Πq(){this.isUpdatePending=!0;try{for(await this.Πg;this.Πo;)await this.Πo}catch(t){Promise.reject(t)}const t=this.performUpdate();return null!=t&&await t,!this.isUpdatePending}performUpdate(){var t;if(!this.isUpdatePending)return;this.hasUpdated,this.Πi&&(this.Πi.forEach(((t,e)=>this[e]=t)),this.Πi=void 0);let e=!1;const i=this.L;try{e=this.shouldUpdate(i),e?(this.willUpdate(i),null===(t=this.ΠU)||void 0===t||t.forEach((t=>{var e;return null===(e=t.hostUpdate)||void 0===e?void 0:e.call(t)})),this.update(i)):this.Π$()}catch(t){throw e=!1,this.Π$(),t}e&&this.E(i)}willUpdate(t){}E(t){var e;null===(e=this.ΠU)||void 0===e||e.forEach((t=>{var e;return null===(e=t.hostUpdated)||void 0===e?void 0:e.call(t)})),this.hasUpdated||(this.hasUpdated=!0,this.firstUpdated(t)),this.updated(t)}Π$(){this.L=new Map,this.isUpdatePending=!1}get updateComplete(){return this.getUpdateComplete()}getUpdateComplete(){return this.Πg}shouldUpdate(t){return!0}update(t){void 0!==this.Πk&&(this.Πk.forEach(((t,e)=>this.Πj(e,this[e],t))),this.Πk=void 0),this.Π$()}updated(t){}firstUpdated(t){}}var f,g,m,v;p.finalized=!0,p.elementProperties=new Map,p.elementStyles=[],p.shadowRootOptions={mode:"open"},null===(a=(o=globalThis).reactiveElementPlatformSupport)||void 0===a||a.call(o,{ReactiveElement:p}),(null!==(l=(h=globalThis).reactiveElementVersions)&&void 0!==l?l:h.reactiveElementVersions=[]).push("1.0.0-rc.2");const y=globalThis.trustedTypes,w=y?y.createPolicy("lit-html",{createHTML:t=>t}):void 0,b=`lit$${(Math.random()+"").slice(9)}$`,S="?"+b,U=`<${S}>`,k=document,_=(t="")=>k.createComment(t),C=t=>null===t||"object"!=typeof t&&"function"!=typeof t,E=Array.isArray,x=/<(?:(!--|\/[^a-zA-Z])|(\/?[a-zA-Z][^>\s]*)|(\/?$))/g,R=/-->/g,P=/>/g,I=/>|[ 	\n\r](?:([^\s"'>=/]+)([ 	\n\r]*=[ 	\n\r]*(?:[^ 	\n\r"'`<>=]|("|')|))|$)/g,T=/'/g,$=/"/g,A=/^(?:script|style|textarea)$/i,B=(t=>(e,...i)=>({_$litType$:t,strings:e,values:i}))(1),F=Symbol.for("lit-noChange"),H=Symbol.for("lit-nothing"),O=new WeakMap,z=k.createTreeWalker(k,129,null,!1);class N{constructor({strings:t,_$litType$:e},i){let s;this.parts=[];let n=0,r=0;const o=t.length-1,a=this.parts,[l,h]=((t,e)=>{const i=t.length-1,s=[];let n,r=2===e?"<svg>":"",o=x;for(let e=0;e<i;e++){const i=t[e];let a,l,h=-1,c=0;for(;c<i.length&&(o.lastIndex=c,l=o.exec(i),null!==l);)c=o.lastIndex,o===x?"!--"===l[1]?o=R:void 0!==l[1]?o=P:void 0!==l[2]?(A.test(l[2])&&(n=RegExp("</"+l[2],"g")),o=I):void 0!==l[3]&&(o=I):o===I?">"===l[0]?(o=null!=n?n:x,h=-1):void 0===l[1]?h=-2:(h=o.lastIndex-l[2].length,a=l[1],o=void 0===l[3]?I:'"'===l[3]?$:T):o===$||o===T?o=I:o===R||o===P?o=x:(o=I,n=void 0);const d=o===I&&t[e+1].startsWith("/>")?" ":"";r+=o===x?i+U:h>=0?(s.push(a),i.slice(0,h)+"$lit$"+i.slice(h)+b+d):i+b+(-2===h?(s.push(void 0),e):d)}const a=r+(t[i]||"<?>")+(2===e?"</svg>":"");return[void 0!==w?w.createHTML(a):a,s]})(t,e);if(this.el=N.createElement(l,i),z.currentNode=this.el.content,2===e){const t=this.el.content,e=t.firstChild;e.remove(),t.append(...e.childNodes)}for(;null!==(s=z.nextNode())&&a.length<o;){if(1===s.nodeType){if(s.hasAttributes()){const t=[];for(const e of s.getAttributeNames())if(e.endsWith("$lit$")||e.startsWith(b)){const i=h[r++];if(t.push(e),void 0!==i){const t=s.getAttribute(i.toLowerCase()+"$lit$").split(b),e=/([.?@])?(.*)/.exec(i);a.push({type:1,index:n,name:e[2],strings:t,ctor:"."===e[1]?W:"?"===e[1]?V:"@"===e[1]?q:j})}else a.push({type:6,index:n})}for(const e of t)s.removeAttribute(e)}if(A.test(s.tagName)){const t=s.textContent.split(b),e=t.length-1;if(e>0){s.textContent=y?y.emptyScript:"";for(let i=0;i<e;i++)s.append(t[i],_()),z.nextNode(),a.push({type:2,index:++n});s.append(t[e],_())}}}else if(8===s.nodeType)if(s.data===S)a.push({type:2,index:n});else{let t=-1;for(;-1!==(t=s.data.indexOf(b,t+1));)a.push({type:7,index:n}),t+=b.length-1}n++}}static createElement(t,e){const i=k.createElement("template");return i.innerHTML=t,i}}function M(t,e,i=t,s){var n,r,o,a;if(e===F)return e;let l=void 0!==s?null===(n=i.Σi)||void 0===n?void 0:n[s]:i.Σo;const h=C(e)?void 0:e._$litDirective$;return(null==l?void 0:l.constructor)!==h&&(null===(r=null==l?void 0:l.O)||void 0===r||r.call(l,!1),void 0===h?l=void 0:(l=new h(t),l.T(t,i,s)),void 0!==s?(null!==(o=(a=i).Σi)&&void 0!==o?o:a.Σi=[])[s]=l:i.Σo=l),void 0!==l&&(e=M(t,l.S(t,e.values),l,s)),e}class D{constructor(t,e){this.l=[],this.N=void 0,this.D=t,this.M=e}u(t){var e;const{el:{content:i},parts:s}=this.D,n=(null!==(e=null==t?void 0:t.creationScope)&&void 0!==e?e:k).importNode(i,!0);z.currentNode=n;let r=z.nextNode(),o=0,a=0,l=s[0];for(;void 0!==l;){if(o===l.index){let e;2===l.type?e=new L(r,r.nextSibling,this,t):1===l.type?e=new l.ctor(r,l.name,l.strings,this,t):6===l.type&&(e=new K(r,this,t)),this.l.push(e),l=s[++a]}o!==(null==l?void 0:l.index)&&(r=z.nextNode(),o++)}return n}v(t){let e=0;for(const i of this.l)void 0!==i&&(void 0!==i.strings?(i.I(t,i,e),e+=i.strings.length-2):i.I(t[e])),e++}}class L{constructor(t,e,i,s){this.type=2,this.N=void 0,this.A=t,this.B=e,this.M=i,this.options=s}setConnected(t){var e;null===(e=this.P)||void 0===e||e.call(this,t)}get parentNode(){return this.A.parentNode}get startNode(){return this.A}get endNode(){return this.B}I(t,e=this){t=M(this,t,e),C(t)?t===H||null==t||""===t?(this.H!==H&&this.R(),this.H=H):t!==this.H&&t!==F&&this.m(t):void 0!==t._$litType$?this._(t):void 0!==t.nodeType?this.$(t):(t=>{var e;return E(t)||"function"==typeof(null===(e=t)||void 0===e?void 0:e[Symbol.iterator])})(t)?this.g(t):this.m(t)}k(t,e=this.B){return this.A.parentNode.insertBefore(t,e)}$(t){this.H!==t&&(this.R(),this.H=this.k(t))}m(t){const e=this.A.nextSibling;null!==e&&3===e.nodeType&&(null===this.B?null===e.nextSibling:e===this.B.previousSibling)?e.data=t:this.$(k.createTextNode(t)),this.H=t}_(t){var e;const{values:i,_$litType$:s}=t,n="number"==typeof s?this.C(t):(void 0===s.el&&(s.el=N.createElement(s.h,this.options)),s);if((null===(e=this.H)||void 0===e?void 0:e.D)===n)this.H.v(i);else{const t=new D(n,this),e=t.u(this.options);t.v(i),this.$(e),this.H=t}}C(t){let e=O.get(t.strings);return void 0===e&&O.set(t.strings,e=new N(t)),e}g(t){E(this.H)||(this.H=[],this.R());const e=this.H;let i,s=0;for(const n of t)s===e.length?e.push(i=new L(this.k(_()),this.k(_()),this,this.options)):i=e[s],i.I(n),s++;s<e.length&&(this.R(i&&i.B.nextSibling,s),e.length=s)}R(t=this.A.nextSibling,e){var i;for(null===(i=this.P)||void 0===i||i.call(this,!1,!0,e);t&&t!==this.B;){const e=t.nextSibling;t.remove(),t=e}}}class j{constructor(t,e,i,s,n){this.type=1,this.H=H,this.N=void 0,this.V=void 0,this.element=t,this.name=e,this.M=s,this.options=n,i.length>2||""!==i[0]||""!==i[1]?(this.H=Array(i.length-1).fill(H),this.strings=i):this.H=H}get tagName(){return this.element.tagName}I(t,e=this,i,s){const n=this.strings;let r=!1;if(void 0===n)t=M(this,t,e,0),r=!C(t)||t!==this.H&&t!==F,r&&(this.H=t);else{const s=t;let o,a;for(t=n[0],o=0;o<n.length-1;o++)a=M(this,s[i+o],e,o),a===F&&(a=this.H[o]),r||(r=!C(a)||a!==this.H[o]),a===H?t=H:t!==H&&(t+=(null!=a?a:"")+n[o+1]),this.H[o]=a}r&&!s&&this.W(t)}W(t){t===H?this.element.removeAttribute(this.name):this.element.setAttribute(this.name,null!=t?t:"")}}class W extends j{constructor(){super(...arguments),this.type=3}W(t){this.element[this.name]=t===H?void 0:t}}class V extends j{constructor(){super(...arguments),this.type=4}W(t){t&&t!==H?this.element.setAttribute(this.name,""):this.element.removeAttribute(this.name)}}class q extends j{constructor(){super(...arguments),this.type=5}I(t,e=this){var i;if((t=null!==(i=M(this,t,e,0))&&void 0!==i?i:H)===F)return;const s=this.H,n=t===H&&s!==H||t.capture!==s.capture||t.once!==s.once||t.passive!==s.passive,r=t!==H&&(s===H||n);n&&this.element.removeEventListener(this.name,this,s),r&&this.element.addEventListener(this.name,this,t),this.H=t}handleEvent(t){var e,i;"function"==typeof this.H?this.H.call(null!==(i=null===(e=this.options)||void 0===e?void 0:e.host)&&void 0!==i?i:this.element,t):this.H.handleEvent(t)}}class K{constructor(t,e,i){this.element=t,this.type=6,this.N=void 0,this.V=void 0,this.M=e,this.options=i}I(t){M(this,t)}}var J,Z,X,Y,G,Q;null===(g=(f=globalThis).litHtmlPlatformSupport)||void 0===g||g.call(f,N,L),(null!==(m=(v=globalThis).litHtmlVersions)&&void 0!==m?m:v.litHtmlVersions=[]).push("2.0.0-rc.3"),(null!==(J=(Q=globalThis).litElementVersions)&&void 0!==J?J:Q.litElementVersions=[]).push("3.0.0-rc.2");class tt extends p{constructor(){super(...arguments),this.renderOptions={host:this},this.Φt=void 0}createRenderRoot(){var t,e;const i=super.createRenderRoot();return null!==(t=(e=this.renderOptions).renderBefore)&&void 0!==t||(e.renderBefore=i.firstChild),i}update(t){const e=this.render();super.update(t),this.Φt=((t,e,i)=>{var s,n;const r=null!==(s=null==i?void 0:i.renderBefore)&&void 0!==s?s:e;let o=r._$litPart$;if(void 0===o){const t=null!==(n=null==i?void 0:i.renderBefore)&&void 0!==n?n:null;r._$litPart$=o=new L(e.insertBefore(_(),t),t,void 0,i)}return o.I(t),o})(e,this.renderRoot,this.renderOptions)}connectedCallback(){var t;super.connectedCallback(),null===(t=this.Φt)||void 0===t||t.setConnected(!0)}disconnectedCallback(){var t;super.disconnectedCallback(),null===(t=this.Φt)||void 0===t||t.setConnected(!1)}render(){return F}}tt.finalized=!0,tt._$litElement$=!0,null===(X=(Z=globalThis).litElementHydrateSupport)||void 0===X||X.call(Z,{LitElement:tt}),null===(G=(Y=globalThis).litElementPlatformSupport)||void 0===G||G.call(Y,{LitElement:tt});const et=t=>{let e=[];for(let i of t)219==i?e=e.concat([219,221]):192==i?e=e.concat([219,220]):e.push(i);return e},it=t=>{let e=[];for(let i=0;i<t.length;i++){let s=t.charCodeAt(i);s<=255&&e.push(s)}return e},st=(t,...e)=>{let i=0;if(t.replace(/[<>]/,"").length!=e.length)throw new Error("Pack format to Argument count mismatch");let s=[],n=!0;const r=(t,e)=>{for(let i=0;i<e;i++)n?s.push(t>>8*i&255):s.push(t>>8*(e-i)&255)};for(let s=0;s<t.length;s++)if("<"==t[s])n=!0;else if(">"==t[s])n=!1;else if("B"==t[s])r(e[i],1),i++;else if("H"==t[s])r(e[i],2),i++;else{if("I"!=t[s])throw new Error(`Unhandled character "${t[s]}" in pack format`);r(e[i],4),i++}return s},nt=(t,e=2)=>"0x"+t.toString(16).toUpperCase().padStart(e,"0"),rt=t=>new Promise((e=>setTimeout(e,t))),ot=it(" UUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUU"),at=50,lt=12882,ht=async t=>{let e;return t==at?e=await import("./esp32-0beba529.js"):t==lt?e=await import("./esp32s2-8f8a89fc.js"):33382==t&&(e=await import("./esp8266-23618669.js")),{...e,text:it(atob(e.text)),data:it(atob(e.data))}};class ct extends EventTarget{constructor(t,e,i){super(),this.port=t,this.logger=e,this._parent=i,this.chipName=null,this._efuses=new Array(4).fill(0),this._flashsize=4194304,this.debug=!1,this.IS_STUB=!1,this.connected=!0}get _inputBuffer(){return this._parent?this._parent._inputBuffer:this.__inputBuffer}async initialize(){await this.softReset(),this._parent||(this.__inputBuffer=[],this.readLoop()),await this.sync();let t,e=await this.readRegister(1610612856);if(353510656==e)this.chipFamily=at;else if(401408==e)this.chipFamily=33382;else{if(1280!=e)throw"Unknown Chip.";this.chipFamily=lt}33382==this.chipFamily?t=1072693328:(this.chipFamily==at||this.chipFamily==lt)&&(t=1610719232);for(let e=0;e<4;e++)this._efuses[e]=await this.readRegister(t+4*e);this.chipFamily==at&&(this.chipName="ESP32"),this.chipFamily==lt&&(this.chipName="ESP32-S2"),33382==this.chipFamily&&(16&this._efuses[0]||65536&this._efuses[2]?this.chipName="ESP8285":this.chipName="ESP8266EX")}async readLoop(){this._reader=this.port.readable.getReader();try{for(;;){const{value:t,done:e}=await this._reader.read();if(e){this._reader.releaseLock();break}t&&0!==t.length&&this._inputBuffer.push(...Array.from(t))}}catch(t){this.connected=!1,this.dispatchEvent(new Event("disconnect"))}}async softReset(){this.logger.log("Try soft reset."),await this.port.setSignals({dataTerminalReady:!1,requestToSend:!0}),await this.port.setSignals({dataTerminalReady:!0,requestToSend:!1}),await new Promise((t=>setTimeout(t,1e3)))}macAddr(){let t,e=new Array(6).fill(0),i=this._efuses[0],s=this._efuses[1],n=this._efuses[2],r=this._efuses[3];if(33382==this.chipFamily){if(0!=r)t=[r>>16&255,r>>8&255,255&r];else if(0==(s>>16&255))t=[24,254,52];else{if(1!=(s>>16&255))throw"Couldnt determine OUI";t=[172,208,116]}e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=s>>8&255,e[4]=255&s,e[5]=i>>24&255}else if(this.chipFamily==at)e[0]=n>>8&255,e[1]=255&n,e[2]=s>>24&255,e[3]=s>>16&255,e[4]=s>>8&255,e[5]=255&s;else{if(this.chipFamily!=lt)throw"Unknown chip family";e[0]=n>>8&255,e[1]=255&n,e[2]=s>>24&255,e[3]=s>>16&255,e[4]=s>>8&255,e[5]=255&s}return e}async readRegister(t){this.debug&&this.logger.debug("Reading Register",t);let e=st("I",t);return((t,e)=>{let i=0,s=[];for(let n of t)if("B"==n)s.push(255&e[i]),i+=1;else if("H"==n)s.push(255&e[i]|(255&e[i+1])<<8),i+=2;else{if("I"!=n)throw new Error(`Unhandled character "${n}" in unpack format`);s.push(255&e[i]|(255&e[i+1])<<8|(255&e[i+2])<<16|(255&e[i+3])<<24),i+=4}return s})("I",(await this.checkCommand(10,e))[0])[0]}async checkCommand(t,e,i=0,s=3e3){s=Math.min(s,12e5),await this.sendCommand(t,e,i);let[n,r]=await this.getResponse(t,s);if(null===r)throw"Didn't get enough status bytes";let o=0;if(this.IS_STUB||33382==this.chipFamily?o=2:[at,lt].includes(this.chipFamily)?o=4:[2,4].includes(r.length)&&(o=r.length),r.length<o)throw"Didn't get enough status bytes";let a=r.slice(-o,r.length);if(r=r.slice(0,-o),this.debug&&(this.logger.debug("status",a),this.logger.debug("value",n),this.logger.debug("data",r)),1==a[0])throw 5==a[1]?"Invalid (unsupported) command "+nt(t):"Command failure error code "+nt(a[1]);return[n,r]}async sendCommand(t,e,i=0){this._inputBuffer.length=0;let s=[192,0];s.push(t),s=s.concat(st("H",e.length)),s=s.concat(et(st("I",i))),s=s.concat(et(e)),s.push(192),this.debug&&this.logger.debug("Writing "+s.length+" byte"+(1==s.length?"":"s")+":",s),await this.writeToStream(s)}async getResponse(t,e=3e3){let i=[],s=0,n=!1,r=Date.now();for(;Date.now()-r<e;){if(this._inputBuffer.length>0){let t=this._inputBuffer.shift();219==t?n=!0:n?(221==t?i.push(220):220==t?i.push(192):i=i.concat([219,t]),n=!1):i.push(t)}else await rt(10);if(i.length>0&&192!=i[0]&&i.shift(),i.length>1&&1!=i[1]&&i.shift(),i.length>2&&i[2]!=t&&i.shift(),i.length>4&&(s=i[3]+(i[4]<<8)),i.length==s+10)break}if(i.length!=s+10)return this.logger.log("Timed out after "+e+" milliseconds"),[null,null];this.debug&&this.logger.debug("Reading "+i.length+" byte"+(1==i.length?"":"s")+":",i);let o=i.slice(5,9),a=i.slice(9,-1);return this.debug&&this.logger.debug("value:",o,"data:",a),[o,a]}async readBuffer(t=3e3){let e=[],i=!1,s=Date.now();for(;Date.now()-s<t;){if(this._inputBuffer.length>0){let t=this._inputBuffer.shift();219==t?i=!0:i?(221==t?e.push(220):220==t?e.push(192):e=e.concat([219,t]),i=!1):e.push(t)}else await rt(10);if(e.length>0&&192!=e[0]&&e.shift(),e.length>1&&192==e[e.length-1])break}if(e.length<2)return this.logger.log("Timed out after "+t+" milliseconds"),null;this.debug&&this.logger.debug("Reading "+e.length+" byte"+(1==e.length?"":"s")+":",e);let n=e.slice(1,-1);return this.debug&&this.logger.debug("data:",n),n}checksum(t,e=239){for(let i of t)e^=i;return e}async setBaudrate(t){if(33382==this.chipFamily)this.logger.log("Baud rate can only change on ESP32 and ESP32-S2");else{this.logger.log("Attempting to change baud rate to "+t+"...");try{let e=st("<II",t,0);await this.checkCommand(15,e),await rt(50),await this.checkCommand(15,e),this.logger.log("Changed baud rate to "+t)}catch(e){throw"Unable to change the baud rate, please try setting the connection speed from "+t+" to 115200 and reconnecting."}}}async sync(){for(let t=0;t<5;t++){if(await this._sync())return await rt(100),!0;await rt(100)}throw"Couldn't sync to ESP. Try resetting."}async _sync(){await this.sendCommand(8,ot);for(let t=0;t<8;t++){let[t,e]=await this.getResponse(8,100);if(null!==e&&(e.length>1&&0==e[0]&&0==e[1]))return!0}return!1}getFlashWriteSize(){return this.chipFamily==lt?1024:512}async flashData(t,e,i=0){let s=t.byteLength;this.logger.log("\nWriting data with filesize:"+s),await this.flashBegin(s,i);let n=[],r=0,o=0,a=0,l=Date.now(),h=this.getFlashWriteSize();for(;s-a>0;)s-a>=h?n=Array.from(new Uint8Array(t,a,h)):(n=Array.from(new Uint8Array(t,a,s-a)),n=n.concat(new Array(h-n.length).fill(255))),await this.flashBlock(n,r,2e3),r+=1,o+=n.length,a+=h,e(o);this.logger.log("Took "+(Date.now()-l)+"ms to write "+s+" bytes")}async flashBlock(t,e,i=100){await this.checkCommand(3,st("<IIII",t.length,e,0,0).concat(t),this.checksum(t),i)}async flashBegin(t=0,e=0,i=!1){let s,n,r=this.getFlashWriteSize();[at,lt].includes(this.chipFamily)&&await this.checkCommand(13,new Array(8).fill(0)),this.chipFamily==at&&(n=st("<IIIIII",0,this._flashsize,65536,4096,256,65535),await this.checkCommand(11,n));let o,a=Math.floor((t+r-1)/r);s=33382==this.chipFamily?this.getEraseSize(e,t):t,o=this.IS_STUB?3e3:((t,e)=>{let i=Math.floor(t*(e/486));return i<3e3?3e3:i})(3e4,t);let l=Date.now();return n=st("<IIII",s,a,r,e),this.chipFamily==lt&&(n=n.concat(st("<I",i?1:0))),this.logger.log("Erase size "+s+", blocks "+a+", block size "+r+", offset "+nt(e,4)+", encrypted "+(i?"yes":"no")),await this.checkCommand(2,n,0,o),0==t||this.IS_STUB||this.logger.log("Took "+(Date.now()-l)+"ms to erase "+a+" bytes"),a}async flashFinish(){let t=st("<I",1);await this.checkCommand(4,t)}getEraseSize(t,e){let i=4096,s=Math.floor((e+i-1)/i),n=16-Math.floor(t/i)%16;return s<n&&(n=s),s<2*n?Math.floor((s+1)/2*i):(s-n)*i}async memBegin(t,e,i,s){return await this.checkCommand(5,st("<IIII",t,e,i,s))}async memBlock(t,e){return await this.checkCommand(7,st("<IIII",t.length,e,0,0).concat(t),this.checksum(t))}async memFinish(t=0){let e=this.IS_STUB?3e3:50,i=st("<II",0==t?1:0,t);return await this.checkCommand(6,i,0,e)}async runStub(){const t=await ht(this.chipFamily);let e=2048;this.logger.log("Uploading stub...");for(let i of["text","data"])if(Object.keys(t).includes(i)){let s=t[i+"_start"],n=t[i].length,r=Math.floor((n+e-1)/e);await this.memBegin(n,r,e,s);for(let s of Array(r).keys()){let r=s*e,o=r+e;o>n&&(o=n),await this.memBlock(t[i].slice(r,o),s)}}this.logger.log("Running stub..."),await this.memFinish(t.entry);const i=await this.readBuffer(100),s=String.fromCharCode(...i);if("OHAI"!=s)throw"Failed to start stub. Unexpected response: "+s;this.logger.log("Stub is now running...");return new dt(this.port,this.logger,this)}async writeToStream(t){const e=this.port.writable.getWriter();await e.write(new Uint8Array(t));try{e.releaseLock()}catch(t){console.error("Ignoring release lock error",t)}}async disconnect(){this._parent?await this._parent.disconnect():(this._reader&&await this._reader.cancel(),await this.port.writable.getWriter().close(),await this.port.close())}}class dt extends ct{constructor(){super(...arguments),this.IS_STUB=!0}async memBegin(t,e,i,s){let n=await ht(this.chipFamily),r=s,o=s+t;console.log(r,o),console.log(n.data_start,n.data.length,n.text_start,n.text.length);for(let[t,e]of[[n.data_start,n.data_start+n.data.length],[n.text_start,n.text_start+n.text.length]])if(r<e&&o>t)throw"Software loader is resident at "+nt(t,8)+"-"+nt(e,8)+". Can't load binary at overlapping address range "+nt(r,8)+"-"+nt(o,8)+". Try changing the binary loading address."}async eraseFlash(){await this.checkCommand(208,[],0,6e5)}}const ut=(t,e)=>"method"===e.kind&&e.descriptor&&!("value"in e.descriptor)?{...e,finisher(i){i.createProperty(e.key,t)}}:{kind:"field",key:Symbol(),placement:"own",descriptor:{},originalKey:e.key,initializer(){"function"==typeof e.initializer&&(this[e.key]=e.initializer.call(this))},finisher(i){i.createProperty(e.key,t)}};const pt=1;const ft=(t=>(...e)=>({_$litDirective$:t,values:e}))(class extends class{constructor(t){}T(t,e,i){this.Σdt=t,this.M=e,this.Σct=i}S(t,e){return this.update(t,e)}update(t,e){return this.render(...e)}}{constructor(t){var e;if(super(t),t.type!==pt||"class"!==t.name||(null===(e=t.strings)||void 0===e?void 0:e.length)>2)throw Error("`classMap()` can only be used in the `class` attribute and must be the only part in the attribute.")}render(t){return Object.keys(t).filter((e=>t[e])).join(" ")}update(t,[e]){if(void 0===this.bt){this.bt=new Set;for(const t in e)e[t]&&this.bt.add(t);return this.render(e)}const i=t.element.classList;this.bt.forEach((t=>{t in e||(i.remove(t),this.bt.delete(t))}));for(const t in e){const s=!!e[t];s!==this.bt.has(t)&&(s?(i.add(t),this.bt.add(t)):(i.remove(t),this.bt.delete(t)))}return F}});var gt=function(t,e,i,s){var n,r=arguments.length,o=r<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,s);else for(var a=t.length-1;a>=0;a--)(n=t[a])&&(o=(r<3?n(o):r>3?n(e,i,o):n(e,i))||o);return r>3&&o&&Object.defineProperty(e,i,o),o};let mt=class extends tt{constructor(){super(...arguments),this._rows=[]}render(){return B`${this._rows.map((t=>B`<div
          class=${ft({error:!0===t.error,action:!0===t.action})}
        >
          ${t.content}
        </div>`))}`}addRow(t){if(t.id&&this._rows.length>0&&this._rows[this._rows.length-1].id===t.id){const e=this._rows.slice(0,-1);e.push(t),this._rows=e}else this._rows=[...this._rows,t]}addError(t){this.addRow({content:t,error:!0})}removeRow(t){this._rows.length>0&&this._rows[this._rows.length-1].id===t&&(this._rows=this._rows.slice(0,-1))}};mt.styles=((t,...e)=>{const s=1===t.length?t[0]:e.reduce(((e,s,n)=>e+(t=>{if(t instanceof i)return t.cssText;if("number"==typeof t)return t;throw Error("Value passed to 'css' function must be a 'css' function result: "+t+". Use 'unsafeCSS' to pass non-literal values, but take care to ensure page security.")})(s)+t[n+1]),t[0]);return n(s)})`
    :host {
      display: block;
      max-width: 500px;
      font-family: monospace;
      background-color: black;
      color: greenyellow;
      font-size: 14px;
      line-height: 19px;
      padding: 12px 16px;
    }

    button {
      background: none;
      color: inherit;
      border: none;
      padding: 0;
      font: inherit;
      text-align: left;
      text-decoration: underline;
      cursor: pointer;
    }

    .action,
    .error {
      margin-top: 1em;
    }

    .error {
      color: red;
    }
  `,gt([function(t){return function(t){return(e,i)=>void 0!==i?((t,e,i)=>{e.constructor.createProperty(i,t)})(t,e,i):ut(t,e)}({...t,state:!0,attribute:!1})}()],mt.prototype,"_rows",void 0),mt=gt([(t=>e=>"function"==typeof e?((t,e)=>(window.customElements.define(t,e),e))(t,e):((t,e)=>{const{kind:i,elements:s}=e;return{kind:i,elements:s,finisher(e){window.customElements.define(t,e)}}})(t,e))("esp-web-flash-log")],mt);const vt=async(t,e,i,s)=>{var n;const r=new URL(e,location.toString()).toString(),o=fetch(r).then((t=>t.json()));let a;try{a=await(async t=>{const e=await navigator.serial.requestPort();return t.log("Connecting..."),await e.open({baudRate:115200}),t.log("Connected successfully."),new ct(e,t)})(t)}catch(t){return}window.esploader=a;const l=document.createElement("esp-web-flash-log");l.addRow({id:"initializing",content:"Initializing..."}),i(l);try{await a.initialize()}catch(t){return console.error(t),void(a.connected&&(l.addError("Failed to initialize. Try resetting your device or holding the BOOT button before clicking connect."),await a.disconnect()))}const h=(t=>{switch(t.chipFamily){case at:return"ESP32";case 33382:return"ESP8266";case lt:return"ESP32-S2";default:return"Unknown Chip"}})(a);let c,d;l.addRow({id:"initializing",content:B`Initialized. Found ${h}`}),l.addRow({id:"manifest",content:"Fetching manifest..."});try{c=await o}catch(t){return l.addError(`Unable to fetch manifest: ${t}`),void await a.disconnect()}l.addRow({id:"manifest",content:B`Found manifest for ${c.name}`});for(const t of c.builds)if(t.chipFamily===h){d=t;break}if(!d)return l.addError(`Your ${h} board is not supported.`),void await a.disconnect();l.addRow({id:"preparing",content:"Preparing installation..."});const u=d.parts.map((async t=>{const e=new URL(t.path,r).toString(),i=await fetch(e);if(!i.ok)throw new Error(`Downlading firmware ${t.path} failed: ${i.status}`);return i.arrayBuffer()}));d.improv&&import("https://www.improv-wifi.com/sdk-js/launch-button.js");const p=await a.runStub(),f=[];let g=0;for(const t of u)try{const e=await t;f.push(e),g+=e.byteLength}catch(t){return l.addError(t.message),void await a.disconnect()}l.addRow({id:"preparing",content:"Ready to install"}),s&&(l.addRow({id:"erase",content:B`Erasing device...`}),await p.eraseFlash(),l.addRow({id:"erase",content:B`Device erased`}));let m=0;l.addRow({id:"write",content:B`Writing progress: ${m}%`});for(const t of d.parts)await p.flashData(f.shift(),(t=>{const e=Math.floor(t/g*100);e!==m&&(m=e,l.addRow({id:"write",content:B`Writing progress: ${e}%`}))}),t.offset);var v;await(v=100,new Promise((t=>setTimeout(t,v)))),await a.softReset();const y=d.improv&&(null===(n=customElements.get("improv-wifi-launch-button"))||void 0===n?void 0:n.isSupported);l.addRow({id:"write",content:B`Writing
    complete${y?"":B`, all done!<br /><br /><button
            @click=${()=>{var t;return null===(t=l.parentElement)||void 0===t?void 0:t.removeChild(l)}}
          >
            Close this dialog
          </button>`}`}),await a.disconnect(),y&&l.addRow({id:"improv",action:!0,content:B`
      <improv-wifi-launch-button
        ><button slot="activate">
          Click here to finish setting up your device.
        </button></improv-wifi-launch-button
      >
    `})};export{vt as startFlash};